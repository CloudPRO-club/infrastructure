{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "storage-name": {
            "type": "string",
            "minLength": 3,
            "maxLength": 24
        },
        "unique-id": {
            "type": "string",
            "defaultValue": "[utcNow()]"
        },
        "scripts-repo-path": {
            "type": "string",
            "defaultValue": "https://github.com/CloudPRO-club/infrastructure"
        },
        "scripts-repo-branch": {
            "type": "string",
            "defaultValue": "main"
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "storage": {
            "name": "[parameters('storage-name')]",
            "sku": "Standard_LRS"
        },
        "site": {
            "index": "index.html",
            "error": "error.html"
        },
        "source": {
            "repo": {
                "path": "[parameters('scripts-repo-path')]",
                "branch": "[parameters('scripts-repo-branch')]"
            }
        },
        "assets": {
            "raw": {
                "path": "[replace(variables('source').repo.path, 'github.com', 'raw.githubusercontent.com')]"
            }
        },
        "general": {
            "uniqueId": "[parameters('unique-id')]",
            "id": "[uniqueString(resourceGroup().id)]"
        },
        "custom": {
            "identity": {
                "name": "[concat('GitHub_Automation_', variables('general').id)]"
            },
            "role": {
                "guid": "[guid(variables('general').uniqueId)]",
                "definitions": {
                    "contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                }
            },
            "scripts": {
                "storage": {
                    "staticWebsite": {
                        "enable": {
                            "name": "[concat(variables('storage').name, '-website')]",
                            "absolutePath": "[concat(variables('assets').raw.path, '/', variables('source').repo.branch, '/wiki/cli/storage-static-website-enable.sh')]",
                            "arguments": "[concat('--name ', variables('storage').name, ' --index ', variables('site').index, ' --error ', variables('site').error)]"
                        }
                    }
                }
            }
        }
    },
    "resources": [
        {
            "name": "[variables('storage').name]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-06-01",
            "location": "[variables('location')]",
            "sku": {
                "name": "[variables('storage').sku]"
            },
            "kind": "StorageV2"
        },
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "name": "[variables('custom').identity.name]",
            "apiVersion": "2018-11-30",
            "location": "[variables('location')]"
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2020-04-01-preview",
            "name": "[variables('custom').role.guid]",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('custom').identity.name)]"
            ],
            "properties": {
                "roleDefinitionId": "[variables('custom').role.definitions.contributor]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('custom').identity.name), '2018-11-30').principalId]",
                "scope": "[resourceGroup().id]",
                "principalType": "ServicePrincipal"
            }
        },
        {
            "name": "[variables('custom').scripts.storage.staticWebsite.enable.name]",
            "type": "Microsoft.Resources/deploymentScripts",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/', variables('storage').name)]",
                "[resourceId('Microsoft.Authorization/roleAssignments', variables('custom').role.guid)]"
            ],
            "apiVersion": "2020-10-01",
            "location": "[variables('location')]",
            "kind": "AzureCLI",
            "identity": {
                "type": "userAssigned",
                "userAssignedIdentities": {
                    "[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities', variables('custom').identity.name)]": {}
                }
            },
            "properties": {
                "forceUpdateTag": "[variables('general').uniqueId]",
                "azCliVersion": "2.30.0",
                "arguments": "[variables('custom').scripts.storage.staticWebsite.enable.arguments]",
                "primaryScriptUri": "[variables('custom').scripts.storage.staticWebsite.enable.absolutePath]",
                "supportingScriptUris": [],
                "timeout": "PT10M",
                "cleanupPreference": "Always",
                "retentionInterval": "P1D"
            }
        }
    ],
    "outputs": {
        "website-url": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storage').name), '2021-06-01', 'Full').properties.primaryEndpoints.web]"
        }
    }
}